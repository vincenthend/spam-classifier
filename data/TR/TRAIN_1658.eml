{'body': 'Hi All,\r\n\r\nI am stuck in the quicktime API ICMDecompressionSessionDecodeFrame()\r\nfor a while, and I could not find any other resources or any other\r\nsample code. Could any body help me out, and any suggestions\r\nappreciated.\r\n\r\nI want to import a movie file from local drive, get the compressed\r\nvideo frames, decode them, and encapsulate them into our own\r\nUncVideoUnit format.\r\nRight now we have already got the compressed video frames, but when we\r\nare trying to decode them, we have got some problem. Here is our\r\nsource code, could any body tell me if there is something wrong in our\r\ncode.\r\n\r\n\r\n\t\t\t// initialize callback structure\r\n\t\t\tICMDecompressionTrackingCallbackRecord callRecord;\r\n\t\t\tcallRecord.decompressionTrackingCallback = WriteFrameToBitmap;\r\n\t\t\tcallRecord.decompressionTrackingRefCon = NULL;\r\n\r\n\r\n\t\t\t// add attributes for pixel buffer that comes out\r\n\t\t\tCFMutableDictionaryRef pixelBufferAttributes = NULL;\r\n\t\t\tpixelBufferAttributes = CFDictionaryCreateMutable( NULL, 0,\r\n&kCFTypeDictionaryKeyCallBacks, &kCFTypeDictionaryValueCallBacks );\r\n\r\n\t\t\tOSType format = k24RGBPixelFormat;\r\n\t\t\tCFNumberRef pFormat = CFNumberCreate( NULL, kCFNumberSInt32Type, &format );\r\n\t\t\tCFDictionaryAddValue( pixelBufferAttributes,\r\nkCVPixelBufferPixelFormatTypeKey, pFormat );\r\n\t\t\tCFRelease( pFormat );\r\n\r\n\t\t\tint width = 1280;\r\n\t\t\tCFNumberRef pWidth = CFNumberCreate( NULL, kCFNumberIntType, &width );\r\n\t\t\tCFDictionaryAddValue( pixelBufferAttributes,\r\nkCVPixelBufferWidthKey, pWidth );\r\n\t\t\tCFRelease( pWidth );\r\n\r\n\t\t\tint height = 720;\r\n\t\t\tCFNumberRef pHeight = CFNumberCreate( NULL, kCFNumberIntType, &height );\r\n\t\t\tCFDictionaryAddValue( pixelBufferAttributes,\r\nkCVPixelBufferHeightKey, pHeight );\r\n\t\t\tCFRelease( pHeight );\r\n\r\n\t\t\t\r\n\t\t\t//  set up decompression session\r\n\t\t\tICMDecompressionSessionRef decompressionSession;\r\n\t\t\tImageDescriptionHandle description =\r\n(ImageDescriptionHandle)NewHandleClear(sizeof(ImageDescription));\r\n\t\t\tOSStatus nStatus = ICMDecompressionSessionCreate ( NULL,\r\ndescription, NULL, pixelBufferAttributes, &callRecord,\r\n&decompressionSession);\r\n\t\t\tCFRelease( pixelBufferAttributes );\r\n\r\n\r\n\t\t\t// get video frames from movie files and decode each frame\r\n\t\t\tTimeValue64 startTime =\r\nGetMediaAdvanceDecodeTime(GetTrackMedia(track));\t\t\t\t\t\t// for starting\r\ntime of each frame\r\n\t\t\tTimeValue64 DurationPerSample = 0;\t\t\t\t// fro duration of each frame\r\n\t\t\tint count = 0;\r\n\t\t\twhile(true)\r\n\t\t\t{\r\n\t\t\t\tByteCount size = 0;\r\n\t\t\t\tUInt8 *aData = new unsigned char[maxDataSize];\r\n\t\t\t\tnErr = GetMediaSample2(videoMedia, aData, maxDataSize, &size,\r\nstartTime, nil, &DurationPerSample, nil, nil, nil, 1, nil, nil);\r\n\r\n\r\n\t\t\t\tOSStatus nStatus = ICMDecompressionSessionDecodeFrame(\r\ndecompressionSession, (const UInt8*)aData, size, NULL, NULL, (void\r\n*)&count );\r\n\r\n\r\n\t\t\t\tcount++;\r\n\t\t\t\tstartTime += DurationPerSample;\r\n\r\n\t\t\t\tif(nErr != noErr)\r\n\t\t\t\t\tbreak;\r\n\r\n\t\t\t\tdelete [] aData;\r\n\t\t\t}\r\n\r\n\r\n\r\nHere is the definition for the callback funtion:\r\n\r\n\r\nstatic void WriteFrameToBitmap(\r\n\t\t\tvoid *decompressionTrackingRefCon,\r\n\t\t\tOSStatus result,\r\n\t\t\tICMDecompressionTrackingFlags decompressionTrackingFlags,\r\n\t\t\tCVPixelBufferRef pixelBuffer,\r\n\t\t\tTimeValue64 displayTime,\r\n\t\t\tTimeValue64 displayDuration,\r\n\t\t\tICMValidTimeFlags validTimeFlags,\r\n\t\t\tvoid *reserved,\r\n\t\t\tvoid *sourceFrameRefCon )\r\n{\r\n\t// when we get decoded frame, print it out to bitmap\r\n\tif ( (result == noErr) && (decompressionTrackingFlags &\r\nkICMDecompressionTracking_EmittingFrame) && pixelBuffer )\r\n\t{\r\n\t\tchar num[16];\r\n\t\tsprintf_s(num, 16, "%d", *((int *)sourceFrameRefCon));\r\n\t\tstd::string strFilePath = std::string("Bitmap0") + std::string(num);\r\n\r\n\t\tboost::shared_ptr<StillImage> pMyImage = StillImage::CreateInstance();\r\n\t\tsize_t size = CVPixelBufferGetDataSize(pixelBuffer);\r\n\t\tBYTE *mem_buffer = (BYTE*)malloc(size * sizeof(BYTE));\r\n\t\tstrcpy((char*)mem_buffer, (char *)CVPixelBufferGetBaseAddress(pixelBuffer));\r\n\t\tpMyImage->LoadImage(mem_buffer, size);\r\n\t\tpMyImage->SaveImage(strFilePath.c_str(), BMP);\r\n\t}\r\n\r\n\r\n}\r\n\r\n\r\nThanks very much.\r\n\r\nBo Peng\r\nSoftware Engineer\r\nCapella Systems, LLC\r\n _______________________________________________\r\nDo not post admin requests to the list. They will be ignored.\r\nQuickTime-API mailing list      (QuickTime-API@lists.apple.com)\r\nHelp/Unsubscribe/Update your Subscription:\r\nhttp://lists.apple.com/mailman/options/quicktime-api/mlsubscriber.tech%40csmining.org\r\n\r\nThis email sent to mlsubscriber.tech@csmining.org\r\n\r\n', 'subject': 'ICMDecompressionSessionDecodeFrame() is not working'}